# ğŸ’¬ ConfiguraÃ§Ã£o do WhatsApp - Chatbot BonnaVitta\n\n**Tempo estimado:** 20-30 minutos\n\n---\n\n## ğŸ“‹ O Que VocÃª Precisa\n\n- Conta Meta (Facebook/Instagram) - https://www.meta.com/\n- Acesso ao Meta Business Suite\n- NÃºmero de telefone para WhatsApp Business\n- URL pÃºblica da sua API\n- Access Token da Meta\n\n---\n\n## ğŸš€ Passo 1: Criar AplicaÃ§Ã£o Meta\n\n### 1.1 Acessar Meta Developers\n\n1. Acesse https://developers.facebook.com/\n2. Clique em \"Get Started\"\n3. FaÃ§a login com sua conta Meta\n\n### 1.2 Criar AplicaÃ§Ã£o\n\n1. Clique em \"My Apps\" â†’ \"Create App\"\n2. Escolha \"Business\" como tipo\n3. Preencha os dados:\n   - **App Name:** \"Chatbot BonnaVitta\"\n   - **App Contact Email:** seu-email@example.com\n   - **App Purpose:** \"Messaging\"\n4. Clique em \"Create App\"\n\n### 1.3 Adicionar Produto WhatsApp\n\n1. Na dashboard do app, clique em \"+ Add Product\"\n2. Procure por \"WhatsApp\"\n3. Clique em \"Set Up\"\n4. Escolha \"WhatsApp Business Account\"\n\n---\n\n## ğŸ“± Passo 2: Configurar Conta WhatsApp Business\n\n### 2.1 Criar Conta Business\n\n1. Acesse https://www.whatsapp.com/business/\n2. Clique em \"Get Started\"\n3. Siga o assistente de configuraÃ§Ã£o\n4. Escolha \"Use existing phone number\" ou \"Get a new number\"\n\n### 2.2 Verificar NÃºmero\n\n1. Insira seu nÃºmero de telefone\n2. Escolha mÃ©todo de verificaÃ§Ã£o (SMS ou chamada)\n3. Insira o cÃ³digo recebido\n4. Confirme\n\n### 2.3 Obter InformaÃ§Ãµes\n\nAnote os seguintes valores:\n\n- **Phone Number ID:** Encontrado em WhatsApp Business â†’ Settings\n- **Business Account ID:** Encontrado em Meta Business Suite\n- **Access Token:** Gerado na prÃ³xima seÃ§Ã£o\n\n---\n\n## ğŸ”‘ Passo 3: Gerar Access Token\n\n### 3.1 Criar Token Permanente\n\n1. Acesse https://developers.facebook.com/docs/whatsapp/cloud-api/get-started\n2. Na seÃ§Ã£o \"Get Access Token\":\n   - Selecione sua aplicaÃ§Ã£o\n   - Clique em \"Generate Token\"\n   - Escolha as permissÃµes:\n     - `whatsapp_business_messaging`\n     - `whatsapp_business_management`\n\n### 3.2 Salvar Token\n\n**Copie o token e salve em um lugar seguro!**\n\nFormato: `EAABs...` (token muito longo)\n\n---\n\n## ğŸ”— Passo 4: Configurar Webhook\n\n### 4.1 Para Desenvolvimento Local (ngrok)\n\n```bash\n# Instalar ngrok (se ainda nÃ£o tiver)\n# Windows: https://ngrok.com/download\n# Mac: brew install ngrok\n# Linux: https://ngrok.com/download\n\n# Executar ngrok\nngrok http 8000\n\n# VocÃª verÃ¡:\n# Forwarding    https://abc123def456.ngrok.io -> http://localhost:8000\n```\n\n**Copie a URL HTTPS**\n\n### 4.2 Para ProduÃ§Ã£o\n\nUse a URL do seu servidor:\n\n```\nhttps://seu-dominio.com\n```\n\n### 4.3 Configurar Webhook na Meta\n\n1. Acesse Meta Developers â†’ Seu App\n2. VÃ¡ para \"WhatsApp\" â†’ \"Configuration\"\n3. Na seÃ§Ã£o \"Webhook\":\n   - **Callback URL:** `https://sua-url.com/api/webhook/whatsapp`\n   - **Verify Token:** Crie um token seguro (ex: \"seu-token-secreto-aqui\")\n4. Clique em \"Verify and Save\"\n\n---\n\n## ğŸ” Passo 5: Configurar VariÃ¡veis de Ambiente\n\nEdite seu arquivo `.env`:\n\n```env\n# WhatsApp\nWHATSAPP_ACCESS_TOKEN=EAABs...\nWHATSAPP_PHONE_NUMBER_ID=123456789\nWHATSAPP_WEBHOOK_TOKEN=seu-token-secreto-aqui\nWHATSAPP_BUSINESS_ACCOUNT_ID=987654321\n```\n\n---\n\n## âœ… Passo 6: Testar Webhook\n\n### 6.1 Iniciar a API\n\n```bash\nnpm run dev\n```\n\n### 6.2 Verificar Webhook\n\nAbra seu navegador e acesse:\n\n```\nhttps://seu-url.com/api/webhook/whatsapp?hub.mode=subscribe&hub.verify_token=seu-token-secreto-aqui&hub.challenge=test\n```\n\n**Resposta esperada:** `test`\n\n### 6.3 Verificar nos Logs\n\nVocÃª deve ver:\n\n```\n[info]: Webhook WhatsApp verificado com sucesso\n```\n\n---\n\n## ğŸ“± Passo 7: Testar Bot no WhatsApp\n\n### 7.1 Enviar Mensagem de Teste\n\nAbra WhatsApp e envie uma mensagem para o nÃºmero da sua conta:\n\n```\nOlÃ¡\n```\n\n### 7.2 Verificar Logs\n\nVocÃª deve ver:\n\n```\n[info]: Mensagem WhatsApp recebida de +55 11 9999-9999: OlÃ¡\n```\n\n### 7.3 Resposta AutomÃ¡tica\n\nO bot deve responder automaticamente com o menu principal.\n\n---\n\n## ğŸ® Passo 8: Testar Fluxo Completo\n\n### 8.1 Enviar Mensagens\n\nNo WhatsApp:\n\n```\n1. Envie: OlÃ¡\n   Resposta: Menu principal com 5 opÃ§Ãµes\n\n2. Envie: 1\n   Resposta: Pergunta qual perÃ­odo\n\n3. Envie: hoje\n   Resposta: Pergunta tipo de consulta\n\n4. Envie: total\n   Resposta: Dados de vendas + grÃ¡fico\n```\n\n### 8.2 Verificar GrÃ¡ficos\n\nOs grÃ¡ficos devem ser enviados como imagens no WhatsApp.\n\n---\n\n## ğŸ”§ Passo 9: ConfiguraÃ§Ãµes AvanÃ§adas\n\n### 9.1 Obter InformaÃ§Ãµes da Conta\n\n```bash\ncurl -X GET \"https://graph.instagram.com/v18.0/YOUR_PHONE_NUMBER_ID\" \\\n  -H \"Authorization: Bearer YOUR_ACCESS_TOKEN\"\n```\n\n### 9.2 Obter InformaÃ§Ãµes de Webhook\n\n```bash\ncurl -X GET \"https://graph.instagram.com/v18.0/YOUR_PHONE_NUMBER_ID/webhook_certificates\" \\\n  -H \"Authorization: Bearer YOUR_ACCESS_TOKEN\"\n```\n\n### 9.3 Testar Envio de Mensagem\n\n```bash\ncurl -X POST \"https://graph.instagram.com/v18.0/YOUR_PHONE_NUMBER_ID/messages\" \\\n  -H \"Authorization: Bearer YOUR_ACCESS_TOKEN\" \\\n  -H \"Content-Type: application/json\" \\\n  -d '{\n    \"messaging_product\": \"whatsapp\",\n    \"to\": \"55119999999\",\n    \"type\": \"text\",\n    \"text\": {\n      \"body\": \"OlÃ¡! Este Ã© um teste.\"\n    }\n  }'\n```\n\n---\n\n## ğŸ“ Tipos de Mensagens Suportadas\n\n### Texto\n\n```json\n{\n  \"messaging_product\": \"whatsapp\",\n  \"to\": \"55119999999\",\n  \"type\": \"text\",\n  \"text\": {\n    \"body\": \"OlÃ¡!\"\n  }\n}\n```\n\n### Imagem\n\n```json\n{\n  \"messaging_product\": \"whatsapp\",\n  \"to\": \"55119999999\",\n  \"type\": \"image\",\n  \"image\": {\n    \"link\": \"https://seu-dominio.com/charts/grafico.png\",\n    \"caption\": \"GrÃ¡fico de vendas\"\n  }\n}\n```\n\n### Documento\n\n```json\n{\n  \"messaging_product\": \"whatsapp\",\n  \"to\": \"55119999999\",\n  \"type\": \"document\",\n  \"document\": {\n    \"link\": \"https://seu-dominio.com/relatorio.pdf\",\n    \"filename\": \"RelatÃ³rio de Vendas.pdf\"\n  }\n}\n```\n\n### BotÃµes\n\n```json\n{\n  \"messaging_product\": \"whatsapp\",\n  \"to\": \"55119999999\",\n  \"type\": \"interactive\",\n  \"interactive\": {\n    \"type\": \"button\",\n    \"body\": {\n      \"text\": \"O que deseja?\"\n    },\n    \"action\": {\n      \"buttons\": [\n        {\n          \"type\": \"reply\",\n          \"reply\": {\n            \"id\": \"1\",\n            \"title\": \"Vendas\"\n          }\n        },\n        {\n          \"type\": \"reply\",\n          \"reply\": {\n            \"id\": \"2\",\n            \"title\": \"Produtos\"\n          }\n        }\n      ]\n    }\n  }\n}\n```\n\n---\n\n## ğŸ› Troubleshooting\n\n### Problema: \"Webhook verification failed\"\n\n```\nCausa: Token incorreto ou URL invÃ¡lida\nSoluÃ§Ã£o:\n1. Verifique se a URL Ã© HTTPS\n2. Verifique se o token estÃ¡ correto em .env\n3. Verifique se o servidor estÃ¡ rodando\n4. Teste a URL no navegador\n```\n\n### Problema: \"Invalid access token\"\n\n```\nCausa: Token expirado ou invÃ¡lido\nSoluÃ§Ã£o:\n1. Regenere o token em Meta Developers\n2. Atualize em .env\n3. Reinicie a API\n```\n\n### Problema: Bot nÃ£o recebe mensagens\n\n```\nCausa: Webhook nÃ£o configurado corretamente\nSoluÃ§Ã£o:\n1. Verifique getWebhookInfo\n2. Reconfigure o webhook\n3. Verifique os logs\n```\n\n### Problema: \"Phone number not registered\"\n\n```\nCausa: NÃºmero nÃ£o verificado\nSoluÃ§Ã£o:\n1. Verifique o nÃºmero em WhatsApp Business\n2. Confirme a verificaÃ§Ã£o\n3. Aguarde 24 horas para ativaÃ§Ã£o\n```\n\n### Problema: Mensagens nÃ£o sÃ£o enviadas\n\n```\nCausa: NÃºmero de destino invÃ¡lido ou conta sem permissÃ£o\nSoluÃ§Ã£o:\n1. Verifique formato: +55 11 99999-9999\n2. Verifique se tem permissÃ£o para enviar\n3. Verifique limite de mensagens (100/dia em teste)\n```\n\n---\n\n## ğŸ“Š Exemplo de ConversaÃ§Ã£o\n\n```\nUsuÃ¡rio: OlÃ¡\nBot: ğŸª Bem-vindo ao Chatbot BonnaVitta\n     O que deseja consultar?\n     1. ğŸ“Š Totalizador de Vendas\n     2. ğŸ‘¥ Vendas por Vendedor\n     3. ğŸ† Ranking de Produtos\n     4. ğŸ“ˆ Performance por Equipe\n     5. ğŸ‘‹ Sair\n\nUsuÃ¡rio: 1\nBot: ğŸ“… Qual perÃ­odo deseja consultar?\n     ğŸ“ Hoje\n     â®ï¸ Ontem\n     ğŸ“† Ãšltimos 7 dias\n     ğŸ“… Este mÃªs\n     âª MÃªs anterior\n     ğŸ”™ Voltar\n\nUsuÃ¡rio: hoje\nBot: ğŸ“Š Totalizador de Vendas\n     Deseja ver:\n     ğŸ“Š Vendas totais (todas as equipes)\n     ğŸ‘¥ Equipe especÃ­fica\n     ğŸ”™ Voltar\n\nUsuÃ¡rio: total\nBot: ğŸ“Š Vendas por Equipe\n     \n     ğŸª Loja\n     ğŸ’° Valor Total: R$ 1.250,00\n     ğŸ« Ticket MÃ©dio: R$ 250,00\n     ğŸ“ˆ TransaÃ§Ãµes: 5\n     ğŸ‘¥ Vendedores: 2\n     \n     [... mais equipes ...]\n     \n     TOTAL GERAL: R$ 9.051,25\n     \n     Deseja ver detalhes de alguma equipe especÃ­fica?\n     \n     [Imagem com grÃ¡fico anexada]\n```\n\n---\n\n## ğŸ” SeguranÃ§a\n\n### Proteger Credenciais\n\n- âœ… Nunca compartilhe o Access Token\n- âœ… Guarde em variÃ¡vel de ambiente\n- âœ… Use HTTPS para webhook\n- âœ… Valide origem das mensagens\n- âœ… Rotacione tokens regularmente\n\n### Validar Mensagens\n\nWhatsApp envia um hash para validar autenticidade:\n\n```typescript\nimport crypto from 'crypto';\n\nfunction validateWebhookSignature(req: Request): boolean {\n  const signature = req.get('x-hub-signature-256');\n  const body = req.rawBody; // Body nÃ£o parseado\n  const token = process.env.WHATSAPP_WEBHOOK_TOKEN;\n  \n  const hash = crypto\n    .createHmac('sha256', token)\n    .update(body)\n    .digest('hex');\n  \n  return `sha256=${hash}` === signature;\n}\n```\n\n---\n\n## ğŸ“š ReferÃªncias\n\n- [Meta WhatsApp Cloud API](https://developers.facebook.com/docs/whatsapp/cloud-api/)\n- [Webhook Setup](https://developers.facebook.com/docs/whatsapp/cloud-api/webhooks/setup-webhooks)\n- [Message Types](https://developers.facebook.com/docs/whatsapp/cloud-api/reference/messages)\n- [Business Account Setup](https://www.whatsapp.com/business/)\n\n---\n\n**Seu bot WhatsApp estÃ¡ configurado e pronto! ğŸ‰**\n
