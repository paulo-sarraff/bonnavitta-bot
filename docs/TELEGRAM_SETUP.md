# ğŸ¤– ConfiguraÃ§Ã£o do Telegram - Chatbot BonnaVitta\n\n**Tempo estimado:** 10-15 minutos\n\n---\n\n## ğŸ“‹ O Que VocÃª Precisa\n\n- Conta Telegram (https://telegram.org/)\n- Acesso ao BotFather (@BotFather no Telegram)\n- URL pÃºblica da sua API (ngrok para desenvolvimento local)\n- Token da API (gerado pelo BotFather)\n\n---\n\n## ğŸš€ Passo 1: Criar Bot no Telegram\n\n### 1.1 Abrir BotFather\n\n1. Abra Telegram\n2. Procure por **@BotFather** (bot oficial do Telegram)\n3. Clique em \"Start\" ou envie `/start`\n\n### 1.2 Criar Novo Bot\n\n1. Envie o comando `/newbot`\n2. O BotFather perguntarÃ¡:\n   - **Nome do bot:** \"Chatbot BonnaVitta\" (pode ser qualquer nome)\n   - **Username do bot:** \"bonnavitta_bot\" (deve ser Ãºnico e terminar com \"_bot\")\n\n### 1.3 Salvar Token\n\nO BotFather retornarÃ¡ algo como:\n\n```\nCongratulations! Your bot has been created.\nHere are your bot's details:\n\nName: Chatbot BonnaVitta\nUsername: @bonnavitta_bot\nToken: 1234567890:ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefgh\n```\n\n**Copie o Token e salve em um lugar seguro!**\n\n---\n\n## ğŸ”— Passo 2: Configurar Webhook (ProduÃ§Ã£o)\n\n### 2.1 Para Desenvolvimento Local (ngrok)\n\nSe vocÃª estÃ¡ desenvolvendo localmente, use ngrok para expor sua API:\n\n```bash\n# Instalar ngrok\n# Windows: https://ngrok.com/download\n# Mac: brew install ngrok\n# Linux: https://ngrok.com/download\n\n# Executar ngrok\nngrok http 8000\n\n# VocÃª verÃ¡:\n# Forwarding    https://abc123def456.ngrok.io -> http://localhost:8000\n```\n\n**Copie a URL HTTPS (https://abc123def456.ngrok.io)**\n\n### 2.2 Para ProduÃ§Ã£o (Render/Vercel)\n\nSe vocÃª deployou em produÃ§Ã£o, use a URL do seu servidor:\n\n```\nhttps://seu-dominio.com\n```\n\n### 2.3 Definir Webhook\n\nAbra seu navegador e acesse:\n\n```\nhttps://api.telegram.org/bot<SEU_TOKEN>/setWebhook?url=<SUA_URL>/api/webhook/telegram\n```\n\n**Exemplo completo:**\n\n```\nhttps://api.telegram.org/bot1234567890:ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefgh/setWebhook?url=https://abc123def456.ngrok.io/api/webhook/telegram\n```\n\n**Resposta esperada:**\n\n```json\n{\n  \"ok\": true,\n  \"result\": true,\n  \"description\": \"Webhook was set\"\n}\n```\n\n---\n\n## ğŸ” Passo 3: Configurar VariÃ¡veis de Ambiente\n\nEdite seu arquivo `.env`:\n\n```env\n# Telegram\nTELEGRAM_BOT_TOKEN=1234567890:ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefgh\nTELEGRAM_WEBHOOK_URL=https://abc123def456.ngrok.io/api/webhook/telegram\n```\n\n---\n\n## âœ… Passo 4: Testar Bot\n\n### 4.1 Iniciar a API\n\n```bash\nnpm run dev\n```\n\n### 4.2 Abrir Bot no Telegram\n\n1. Procure por **@bonnavitta_bot** no Telegram\n2. Clique em \"Start\"\n3. Envie uma mensagem qualquer\n\n### 4.3 Verificar Logs\n\nVocÃª deve ver nos logs:\n\n```\n[info]: Telegram webhook recebido: {...}\n[info]: Mensagem Telegram de usuario_name (123456789): OlÃ¡\n```\n\n---\n\n## ğŸ® Passo 5: Testar Fluxo Completo\n\n### 5.1 Enviar Mensagens de Teste\n\nNo chat do bot no Telegram:\n\n```\n1. Envie: /start\n   Resposta: Menu principal com 5 opÃ§Ãµes\n\n2. Envie: 1\n   Resposta: Pergunta qual perÃ­odo\n\n3. Envie: hoje\n   Resposta: Pergunta tipo de consulta\n\n4. Envie: total\n   Resposta: Dados de vendas + grÃ¡fico\n```\n\n### 5.2 Verificar GrÃ¡ficos\n\nOs grÃ¡ficos devem ser enviados como fotos no Telegram.\n\n---\n\n## ğŸ”§ Passo 6: ConfiguraÃ§Ãµes AvanÃ§adas\n\n### 6.1 Obter InformaÃ§Ãµes do Webhook\n\n```\nhttps://api.telegram.org/bot<SEU_TOKEN>/getWebhookInfo\n```\n\n**Resposta:**\n\n```json\n{\n  \"ok\": true,\n  \"result\": {\n    \"url\": \"https://abc123def456.ngrok.io/api/webhook/telegram\",\n    \"has_custom_certificate\": false,\n    \"pending_update_count\": 0,\n    \"ip_address\": \"123.45.67.89\",\n    \"last_error_date\": null,\n    \"last_error_message\": null,\n    \"last_synchronization_error_date\": null,\n    \"max_connections\": 40,\n    \"allowed_updates\": [\"message\", \"callback_query\"]\n  }\n}\n```\n\n### 6.2 Remover Webhook (Voltar para Polling)\n\n```\nhttps://api.telegram.org/bot<SEU_TOKEN>/deleteWebhook\n```\n\n### 6.3 Obter InformaÃ§Ãµes do Bot\n\n```\nhttps://api.telegram.org/bot<SEU_TOKEN>/getMe\n```\n\n---\n\n## ğŸ“ Comandos do Bot\n\nVocÃª pode configurar comandos no BotFather:\n\n```\n/start - Iniciar conversa\n/menu - Ver menu principal\n/vendas - Consultar vendas\n/help - Ajuda\n/sair - Encerrar\n```\n\nPara configurar:\n\n1. Envie `/setcommands` para @BotFather\n2. Selecione seu bot\n3. Envie a lista de comandos\n\n---\n\n## ğŸ› Troubleshooting\n\n### Problema: \"Webhook was not set\"\n\n```\nCausa: URL invÃ¡lida ou servidor nÃ£o respondendo\nSoluÃ§Ã£o:\n1. Verifique se a URL Ã© HTTPS\n2. Verifique se o servidor estÃ¡ rodando\n3. Teste a URL no navegador\n```\n\n### Problema: Bot nÃ£o recebe mensagens\n\n```\nCausa: Webhook nÃ£o configurado corretamente\nSoluÃ§Ã£o:\n1. Verifique getWebhookInfo\n2. Reconfigure o webhook\n3. Verifique os logs da API\n```\n\n### Problema: \"Webhook updates failed\"\n\n```\nCausa: Erro ao processar mensagem\nSoluÃ§Ã£o:\n1. Verifique os logs em logs/error.log\n2. Verifique se o banco estÃ¡ conectado\n3. Verifique se o token estÃ¡ correto\n```\n\n### Problema: GrÃ¡ficos nÃ£o aparecem\n\n```\nCausa: Puppeteer nÃ£o consegue gerar imagem\nSoluÃ§Ã£o:\n1. Verifique se Puppeteer estÃ¡ instalado\n2. Verifique permissÃµes de escrita em /charts\n3. Verifique logs de erro\n```\n\n---\n\n## ğŸ“Š Exemplo de ConversaÃ§Ã£o\n\n```\nUsuÃ¡rio: /start\nBot: ğŸª Bem-vindo ao Chatbot BonnaVitta\n     O que deseja consultar?\n     1. ğŸ“Š Totalizador de Vendas\n     2. ğŸ‘¥ Vendas por Vendedor\n     3. ğŸ† Ranking de Produtos\n     4. ğŸ“ˆ Performance por Equipe\n     5. ğŸ‘‹ Sair\n\nUsuÃ¡rio: 1\nBot: ğŸ“… Qual perÃ­odo deseja consultar?\n     ğŸ“ Hoje\n     â®ï¸ Ontem\n     ğŸ“† Ãšltimos 7 dias\n     ğŸ“… Este mÃªs\n     âª MÃªs anterior\n     ğŸ”™ Voltar\n\nUsuÃ¡rio: hoje\nBot: ğŸ“Š Totalizador de Vendas\n     Deseja ver:\n     ğŸ“Š Vendas totais (todas as equipes)\n     ğŸ‘¥ Equipe especÃ­fica\n     ğŸ”™ Voltar\n\nUsuÃ¡rio: total\nBot: ğŸ“Š Vendas por Equipe\n     \n     ğŸª Loja\n     ğŸ’° Valor Total: R$ 1.250,00\n     ğŸ« Ticket MÃ©dio: R$ 250,00\n     ğŸ“ˆ TransaÃ§Ãµes: 5\n     ğŸ‘¥ Vendedores: 2\n     \n     [... mais equipes ...]\n     \n     TOTAL GERAL: R$ 9.051,25\n     \n     Deseja ver detalhes de alguma equipe especÃ­fica?\n     \n     [Imagem com grÃ¡fico anexada]\n```\n\n---\n\n## ğŸ” SeguranÃ§a\n\n### Proteger Token\n\n- âœ… Nunca compartilhe o token\n- âœ… Guarde em variÃ¡vel de ambiente\n- âœ… Use HTTPS para webhook\n- âœ… Valide origem das mensagens\n\n### Validar Mensagens\n\nTelegram envia um hash para validar autenticidade:\n\n```typescript\n// Validar hash da mensagem\nconst crypto = require('crypto');\nconst hash = update.message.hash;\nconst data = JSON.stringify(update);\nconst calculatedHash = crypto\n  .createHmac('sha256', token)\n  .update(data)\n  .digest('hex');\n\nif (hash !== calculatedHash) {\n  // Mensagem invÃ¡lida\n}\n```\n\n---\n\n## ğŸ“š ReferÃªncias\n\n- [Telegram Bot API](https://core.telegram.org/bots/api)\n- [Webhook Setup](https://core.telegram.org/bots/webhooks)\n- [BotFather Commands](https://core.telegram.org/bots#botfather)\n\n---\n\n**Seu bot Telegram estÃ¡ configurado e pronto! ğŸ‰**\n
